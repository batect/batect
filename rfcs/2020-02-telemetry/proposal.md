# Problem statement

At present, visibility into users' experience with batect is larely driven by bug reports, feature requests and community chat conversations, making remediation of issues reactive and making it difficult to quantify the impact of different decisions. Furthermore, the lack of data on users, their behaviour and environments makes it difficult to make data-driven decisions about features and prioritisation.



# Proposed solution

As an initial step, this RFC proposes collecting information about batect and the environment it is running in as well as statistical information about how it is used and how it performs.



Specifically, the following environmental information would be collected:

* batect version (eg. `0.51.0`)

  *Rationale for collection: helps correlate and compare results for different versions of batect*

* OS and version (eg. `Mac OS X 10.15.4 (x86_64)`)

  *Rationale for collection: helps correlate and compare results for different operating systems and OS versions and helps plan compatibility changes for different operating systems (eg. dropping support for an older version of an operating system no longer commonly used)*

* Docker version (eg. `19.03.8`)

  *Rationale for collection: helps correlate and compare results for different versions of Docker and helps plan compatibility changes for different versions of Docker (eg. dropping support for an older version of Docker no longer commonly used)*

* JVM version (eg. `Oracle Corporation Java HotSpot(TM) 64-Bit Server VM 1.8.0_162`)

  *Rationale for collection: helps correlate and compare results for different JVMs and helps plan compatibility changes for different JVMs (eg. dropping support for an older version of Java no longer commonly used)*

* Git version (eg. `2.27.0`)

  *Rationale for collection: helps correlate and compare results for different versions of Git and helps plan compatibility changes for different versions of Git (eg. dropping support for an older version of Git no longer commonly used)*

* Shell (eg. `bash` or `fish`)

  *Rationale for collection: helps plan and prioritise possible future features (eg. shell tab completion)*

* Terminal type (value of the `TERM` environment variable - eg. `xterm-256color`)

  *Rationale for collection: helps plan and prioritise possible future features (eg. CLI output options)*

* Whether batect believes it is running on a CI tool, and the name of the CI tool (eg. `GitHub Actions`, `CircleCI` or `Jenkins`)

  *Rationale for collection: helps correlate and compare results for different CI tools, helps plan documentation improvements (eg. adding documentation for commonly used CI tools not yet covered in the documentation), helps plan and prioritise possible future features (eg. closer integration with CI tools)*

* Whether the wrapper script downloaded the current version of batect for this invocation

  *Rationale for collection: helps compare telemetry data with download statistics to determine roughly what proportion of users enable telemetry*

* A unique, autogenerated user ID used to correlate information across invocations (a [version 4 randomly-generated UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random)))

  *Rationale for collection: helps correlate results across invocations (eg. how often users batect, how quickly users upgrade from one version to another) and helps calculate usage statistics (eg. weekly active users)*

* A unique, autogenerated session ID (a [version 4 randomly-generated UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random)))

  *Rationale for collection: allows easy identification and deduplication of uploaded data*



The following usage information would be collected for all commands:

* The command (eg. running a task, upgrading batect or displaying help)

  *Rationale for collection: helps segment data (eg. determining average command duration for `--upgrade`) and understand usage behaviour (eg. how often `--help` is used)*
* The total duration of the command

  *Rationale for collection: helps understand performance of batect under different circumstances*
* The time the command started in UTC

  *Rationale for collection: provides an ordering of invocations and helps determine average time between invocations*
* The output mode used (`simple`, `fancy`, `quiet` or `all`) and whether `--no-color` is enabled

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features*
* The Docker connection type (Unix socket, Windows named pipe or TCP) and whether `--docker-tls` or `--docker-tls-verify` is set

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features*



When a task is run, the following usage information would also be collected:

* The type of container being run (Windows or Linux)

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features*
* The type of cache being used (volume or directory)

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features*
* The total number of tasks in the project

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features (eg. performance improvements for very large projects)*
* The total number of containers in the project

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features (eg. performance improvements for very large projects)*
* The total number of configuration variables in the project

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features (eg. performance improvements for very large projects)*
* The total number of prerequisite tasks required to execute before executing the main task

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features (eg. performance improvements for very large projects)*
* The number of containers started for each task

  *Rationale for collection: helps understand usage behaviour and helps plan and prioritise possible future features (eg. performance improvements for very large projects)*
* The time taken to load the configuration for the project

  *Rationale for collection: helps understand usage and application behaviour and helps plan and prioritise possible future features (eg. performance improvements for very large projects)*
* The time taken to execute each task

  *Rationale for collection: helps understand usage and application behaviour and helps plan and prioritise possible future features (eg. performance improvements for very large projects)*
* The time taken to execute each step in each task (eg. pulling or building a image, creating a container, stopping a container, removing a container)

  *Rationale for collection: helps understand usage and application behaviour and helps plan and prioritise possible future features (eg. performance improvements for certain steps)*



When an exception occurs that batect cannot recover from, the following information would be collected:

* the type of exception (eg. `IOException` or `ContainerCreationFailedException`)
* the stack trace

The exception's message must not be collected as it may contain sensitive or confidential information.

*Rationale for collection: helps understand possible bugs, helps understand the frequency with which users see certain classes of errors and hepls plan and prioritise possible future features (eg. recovering from errors automatically or suggesting recovery actions to the user)*



There are also a number of other considerations:

* Users must be able to opt-out on a per-command and global basis
* Organisations must be able to block telemetry submission or opt-out on a network level
* Collecting this information must have a minimal performance impact
* We must not collect any personally identifiable information or collect any potentially sensitive or confidential information such as file names or the names or contents of projects, containers, images or tasks



# Details

## Documentation changes

A privacy policy will be added to the documentation to explain what information is collected, how it is collected, who has access to it and how to opt-out or block submission of this information.

[Automattic's privacy policy](https://github.com/Automattic/legalmattic/blob/master/Privacy-Policy.md) is available under a Creative Commons license and could be used as a template.

Opting out or blocking collection of telemetry information would be supported through multiple mechanisms:

* `--disable-telemetry` command line flag to disable telemetry for a single invocation
* `--permanently-disable-telemetry` command line flag to permanently disable telemetry (equivalent to answering 'no' to the consent prompt below)
* `BATECT_ENABLE_TELEMETRY` environment variable set to `0` or `false`
* Blocking HTTPS traffic to the `api.abacus.batect.dev` domain at a network level (eg. at a proxy)



## CLI changes

`./batect --disable-telemetry <task>` would disable both collection of telemetry data and submission of cached data from previous invocations during just that command line invocation. Setting the `BATECT_ENABLE_TELEMETRY` environment variable to `0` or `false` would have the same result.

`./batect --permanently-disable-telemetry` would permanently disable both collection of telemetry data and submission of cached data from previous invocations (equivalent to answering 'no' to the consent prompt below), and delete any cached telemetry data that is yet to be uploaded. `./batect --permanently-enable-telemetry` would re-enable collection and submission of telemetry data.



## Behaviour changes

### On first run with telemetry not explicitly disabled

Provided telemetry is not explictly disabled through any of the mechanisms listed above, and that batect is running with a TTY and does not detect it is running on CI, batect would show the following prompt the first time it is run:

```
batect can collect and report anonymous environment, usage and performance information. This information does not include personal or sensitive information, and is used to help improve batect.
More information, including details of what information is collected and a formal privacy policy, is available at https://batect.dev/Telemetry.html.

Is it OK for batect to collect and report this information? (Y/n)
```

If the user presses Enter, or enters anything starting with a `y`, batect would store this preference and enable telemetry capture and reporting. If the user enters anything starting with a `n`, batect would store this preference and not prompt the user again. If the user enters anything else, it would repeat the prompt until it receives a valid answer.



On CI, or when stdin is not connected to a TTY, the following message would be shown:

```
batect can collect and report anonymous environment, usage and performance information. This information does not include personal or sensitive information, and is used to help improve batect.
More information, including details of what information is collected and a formal privacy policy, is available at https://batect.dev/Telemetry.html.

It looks like batect is running in a non-interactive session, so it can't ask for permission to collect and report this information.
* To suppress this message and allow collection and reporting of telemetry data, set the BATECT_ENABLE_TELEMETRY environment variable to 'true', or run `./batect --permanently-enable-telemetry`.
* To suppress this message and prevent collection and reporting of telemetry data, set the BATECT_ENABLE_TELEMETRY environment variable to 'false', or run `./batect --permanently-disable-telemetry`.

No data will be collected for this session.
```



### On all runs with telemetry enabled

batect would collect the information described above and write it to disk at `~/.batect/telemetry` for upload in the background of subsequent runs (see below).



### On subsequent runs with telemetry enabled

In the background upon startup, batect would check for cached information from previous runs written to `~/.batect/telemetry`. If any is present, it will upload each run (one at a time) and delete each run after a successful upload. If a run fails to upload and is less than 30 days old, it is left on disk to be retried as part of a subsequent run. If a run fails to upload and is more than 30 days old, it is deleted.

To prevent a malformed run from preventing other runs from being uploaded, the upload order of the cached runs will be randomised.

All data will be uploaded over a HTTPS connection.



### On any run with telemetry disabled

Telemetry data will not be written to disk, and any cached information will not be uploaded.



### On CI with telemetry enabled

Many CI systems operate ephemeral agents, with each new build given a clean agent. While this is great for ensuring consistency of builds, it presents problems for the delayed data reporting mechanism described above - data from previous runs would never be uploaded because it is lost when the agent is destroyed.

To compensate for this, when batect detects that it is running on CI, it would attempt to immediately upload the data at the end of the run and not write it to disk if this succeeds. To prevent this from unnecessarily delaying the CI build, the upload process will be given a short timeout (maximum of 5 seconds) and any errors will cause the upload to be aborted and the data written to disk as per normal instead.



## Impacts on other features

None anticipated.



## Prior art

A summary of the data collection practices of other similar tools:

| Name                      | Data collected                                               | Default state                                                | Notes                                                        |
| ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| GCP CLI                   | "anonymized `gcloud` command and other Cloud SDK command-line tool executions" ([source](https://cloud.google.com/sdk/usage-statistics)) | [Permission requested on first run](https://cloud.google.com/sdk/usage-statistics) | Privacy policy is global Google privacy policy               |
| Docker Desktop            | "error reports, system version and language as well as Docker Desktop lifecycle information (e.g., starts, stops, resets)" | [Enabled by default, message on first run](https://docs.docker.com/docker-for-windows/#general) | Image in [this section of the documentation](https://docs.docker.com/docker-for-windows/install/#start-docker-desktop) shows first run message, no link to privacy policy |
| IntelliJ                  | Listed at https://www.jetbrains.com/help/idea/settings-usage-statistics.html | Permission requested on first run                            | Mentioned in global [privacy policy](https://www.jetbrains.com/company/privacy.html), settings apply to all JetBrains IDEs |
| [Fork](https://fork.dev/) | Unclear                                                      | [Enabled by default, no message](https://github.com/ForkIssues/Tracker/issues/313) | No privacy policy, can't find details on data collected      |
| SourceTree                | "the number of repos you've interacted with and the provider you're using" ([source](https://community.atlassian.com/t5/Sourcetree-questions/Security-information-about-Sourcetree/qaq-p/1104747#M29899)) | [Permission requested on first run](https://community.atlassian.com/t5/Sourcetree-questions/Security-information-about-Sourcetree/qaq-p/1104747#M29899) | Data collection removed altogether as of v4 (October 2019)   |
| Homebrew                  | Listed at https://docs.brew.sh/Analytics                     | [Enabled by default, message on first run](https://docs.brew.sh/Analytics) | No privacy policy                                            |
